{"ast":null,"code":"export const createBrokerFactory = (createOrGetOngoingRequests, extendBrokerImplementation, generateUniqueNumber, isMessagePort) => brokerImplementation => {\n  const fullBrokerImplementation = extendBrokerImplementation(brokerImplementation);\n  return sender => {\n    const ongoingRequests = createOrGetOngoingRequests(sender);\n    sender.addEventListener('message', ({\n      data: message\n    }) => {\n      const {\n        id\n      } = message;\n      if (id !== null && ongoingRequests.has(id)) {\n        const {\n          reject,\n          resolve\n        } = ongoingRequests.get(id);\n        ongoingRequests.delete(id);\n        if (message.error === undefined) {\n          resolve(message.result);\n        } else {\n          reject(new Error(message.error.message));\n        }\n      }\n    });\n    if (isMessagePort(sender)) {\n      sender.start();\n    }\n    const call = (method, params = null, transferables = []) => {\n      return new Promise((resolve, reject) => {\n        const id = generateUniqueNumber(ongoingRequests);\n        ongoingRequests.set(id, {\n          reject,\n          resolve\n        });\n        if (params === null) {\n          sender.postMessage({\n            id,\n            method\n          }, transferables);\n        } else {\n          sender.postMessage({\n            id,\n            method,\n            params\n          }, transferables);\n        }\n      });\n    };\n    const notify = (method, params, transferables = []) => {\n      sender.postMessage({\n        id: null,\n        method,\n        params\n      }, transferables);\n    };\n    let functions = {};\n    for (const [key, handler] of Object.entries(fullBrokerImplementation)) {\n      functions = {\n        ...functions,\n        [key]: handler({\n          call,\n          notify\n        })\n      };\n    }\n    return {\n      ...functions\n    };\n  };\n};","map":{"version":3,"names":["createBrokerFactory","createOrGetOngoingRequests","extendBrokerImplementation","generateUniqueNumber","isMessagePort","brokerImplementation","fullBrokerImplementation","sender","ongoingRequests","addEventListener","data","message","id","has","reject","resolve","get","delete","error","undefined","result","Error","start","call","method","params","transferables","Promise","set","postMessage","notify","functions","key","handler","Object","entries"],"sources":["C:\\Users\\toecm\\Documents\\PureConvo\\pure-app\\node_modules\\broker-factory\\src\\factories\\create-broker.ts"],"sourcesContent":["import type { generateUniqueNumber as generateUniqueNumberFunction } from 'fast-unique-numbers';\nimport { IWorkerDefinition, IWorkerErrorMessage, IWorkerResultMessage } from 'worker-factory';\nimport type { isMessagePort as isMessagePortFunction } from '../guards/message-port';\nimport { IBrokerDefinition, IDefaultBrokerDefinition, IWorkerEvent } from '../interfaces';\nimport { TBrokerImplementation } from '../types';\nimport type { createCreateOrGetOngoingRequests } from './create-or-get-ongoing-requests';\nimport type { createExtendBrokerImplementation } from './extend-broker-implementation';\n\nexport const createBrokerFactory =\n    (\n        createOrGetOngoingRequests: ReturnType<typeof createCreateOrGetOngoingRequests>,\n        extendBrokerImplementation: ReturnType<typeof createExtendBrokerImplementation>,\n        generateUniqueNumber: typeof generateUniqueNumberFunction,\n        isMessagePort: typeof isMessagePortFunction\n    ) =>\n    <T extends IBrokerDefinition, U extends IWorkerDefinition>(\n        brokerImplementation: TBrokerImplementation<T, U>\n    ): ((sender: MessagePort | Worker) => T & IDefaultBrokerDefinition) => {\n        const fullBrokerImplementation = extendBrokerImplementation(brokerImplementation);\n\n        return (sender: MessagePort | Worker) => {\n            const ongoingRequests = createOrGetOngoingRequests(sender);\n\n            sender.addEventListener('message', <EventListener>(({ data: message }: IWorkerEvent) => {\n                const { id } = message;\n\n                if (id !== null && ongoingRequests.has(id)) {\n                    const { reject, resolve } = <{ reject: Function; resolve: Function }>ongoingRequests.get(id);\n\n                    ongoingRequests.delete(id);\n\n                    if ((<IWorkerErrorMessage>message).error === undefined) {\n                        resolve((<IWorkerResultMessage>message).result);\n                    } else {\n                        reject(new Error((<IWorkerErrorMessage>message).error.message));\n                    }\n                }\n            }));\n\n            if (isMessagePort(sender)) {\n                sender.start();\n            }\n\n            const call = <V extends keyof U>(method: V, params: U[V]['params'] = null, transferables: U[V]['transferables'] = []) => {\n                return new Promise<U[V]['response']['result']>((resolve, reject) => {\n                    const id = generateUniqueNumber(ongoingRequests);\n\n                    ongoingRequests.set(id, { reject, resolve });\n\n                    if (params === null) {\n                        sender.postMessage({ id, method }, <Transferable[]>transferables);\n                    } else {\n                        sender.postMessage({ id, method, params }, <Transferable[]>transferables);\n                    }\n                });\n            };\n            const notify = <V extends keyof U>(method: V, params: U[V]['params'], transferables: U[V]['transferables'] = []) => {\n                sender.postMessage({ id: null, method, params }, <Transferable[]>transferables);\n            };\n\n            let functions: object = {};\n\n            for (const [key, handler] of Object.entries(fullBrokerImplementation)) {\n                functions = { ...functions, [key]: handler({ call, notify }) };\n            }\n\n            return <T & IDefaultBrokerDefinition>{ ...functions };\n        };\n    };\n"],"mappings":"AAQA,OAAO,MAAMA,mBAAmB,GAC5BA,CACIC,0BAA+E,EAC/EC,0BAA+E,EAC/EC,oBAAyD,EACzDC,aAA2C,KAG3CC,oBAAiD,IACiB;EAClE,MAAMC,wBAAwB,GAAGJ,0BAA0B,CAACG,oBAAoB,CAAC;EAEjF,OAAQE,MAA4B,IAAI;IACpC,MAAMC,eAAe,GAAGP,0BAA0B,CAACM,MAAM,CAAC;IAE1DA,MAAM,CAACE,gBAAgB,CAAC,SAAS,EAAkB,CAAC;MAAEC,IAAI,EAAEC;IAAO,CAAgB,KAAI;MACnF,MAAM;QAAEC;MAAE,CAAE,GAAGD,OAAO;MAEtB,IAAIC,EAAE,KAAK,IAAI,IAAIJ,eAAe,CAACK,GAAG,CAACD,EAAE,CAAC,EAAE;QACxC,MAAM;UAAEE,MAAM;UAAEC;QAAO,CAAE,GAA4CP,eAAe,CAACQ,GAAG,CAACJ,EAAE,CAAC;QAE5FJ,eAAe,CAACS,MAAM,CAACL,EAAE,CAAC;QAE1B,IAA0BD,OAAQ,CAACO,KAAK,KAAKC,SAAS,EAAE;UACpDJ,OAAO,CAAwBJ,OAAQ,CAACS,MAAM,CAAC;QACnD,CAAC,MAAM;UACHN,MAAM,CAAC,IAAIO,KAAK,CAAuBV,OAAQ,CAACO,KAAK,CAACP,OAAO,CAAC,CAAC;QACnE;MACJ;IACJ,CAAE,CAAC;IAEH,IAAIP,aAAa,CAACG,MAAM,CAAC,EAAE;MACvBA,MAAM,CAACe,KAAK,EAAE;IAClB;IAEA,MAAMC,IAAI,GAAGA,CAAoBC,MAAS,EAAEC,MAAA,GAAyB,IAAI,EAAEC,aAAA,GAAuC,EAAE,KAAI;MACpH,OAAO,IAAIC,OAAO,CAA6B,CAACZ,OAAO,EAAED,MAAM,KAAI;QAC/D,MAAMF,EAAE,GAAGT,oBAAoB,CAACK,eAAe,CAAC;QAEhDA,eAAe,CAACoB,GAAG,CAAChB,EAAE,EAAE;UAAEE,MAAM;UAAEC;QAAO,CAAE,CAAC;QAE5C,IAAIU,MAAM,KAAK,IAAI,EAAE;UACjBlB,MAAM,CAACsB,WAAW,CAAC;YAAEjB,EAAE;YAAEY;UAAM,CAAE,EAAkBE,aAAa,CAAC;QACrE,CAAC,MAAM;UACHnB,MAAM,CAACsB,WAAW,CAAC;YAAEjB,EAAE;YAAEY,MAAM;YAAEC;UAAM,CAAE,EAAkBC,aAAa,CAAC;QAC7E;MACJ,CAAC,CAAC;IACN,CAAC;IACD,MAAMI,MAAM,GAAGA,CAAoBN,MAAS,EAAEC,MAAsB,EAAEC,aAAA,GAAuC,EAAE,KAAI;MAC/GnB,MAAM,CAACsB,WAAW,CAAC;QAAEjB,EAAE,EAAE,IAAI;QAAEY,MAAM;QAAEC;MAAM,CAAE,EAAkBC,aAAa,CAAC;IACnF,CAAC;IAED,IAAIK,SAAS,GAAW,EAAE;IAE1B,KAAK,MAAM,CAACC,GAAG,EAAEC,OAAO,CAAC,IAAIC,MAAM,CAACC,OAAO,CAAC7B,wBAAwB,CAAC,EAAE;MACnEyB,SAAS,GAAG;QAAE,GAAGA,SAAS;QAAE,CAACC,GAAG,GAAGC,OAAO,CAAC;UAAEV,IAAI;UAAEO;QAAM,CAAE;MAAC,CAAE;IAClE;IAEA,OAAqC;MAAE,GAAGC;IAAS,CAAE;EACzD,CAAC;AACL,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}